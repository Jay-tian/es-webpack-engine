'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _path=require('path');var _path2=_interopRequireDefault(_path);var _webpack=require('webpack');var _webpack2=_interopRequireDefault(_webpack);var _happypack=require('happypack');var _happypack2=_interopRequireDefault(_happypack);var _webpackMerge=require('webpack-merge');var _webpackMerge2=_interopRequireDefault(_webpackMerge);var _esExtractTextWebpackPlugin=require('es-extract-text-webpack-plugin');var _esExtractTextWebpackPlugin2=_interopRequireDefault(_esExtractTextWebpackPlugin);var _chunkManifestWebpackPlugin=require('chunk-manifest-webpack-plugin');var _chunkManifestWebpackPlugin2=_interopRequireDefault(_chunkManifestWebpackPlugin);var _optimizeModuleidAndChunkidPlugin=require('optimize-moduleid-and-chunkid-plugin');var _optimizeModuleidAndChunkidPlugin2=_interopRequireDefault(_optimizeModuleidAndChunkidPlugin);var _copyWebpackPlugin=require('copy-webpack-plugin');var _copyWebpackPlugin2=_interopRequireDefault(_copyWebpackPlugin);var _es3ifyWebpackPlugin=require('es3ify-webpack-plugin');var _es3ifyWebpackPlugin2=_interopRequireDefault(_es3ifyWebpackPlugin);var _webpackBundleAnalyzer=require('webpack-bundle-analyzer');var _friendlyErrorsWebpackPlugin=require('friendly-errors-webpack-plugin');var _friendlyErrorsWebpackPlugin2=_interopRequireDefault(_friendlyErrorsWebpackPlugin);var _options=require('./config/options');var _options2=_interopRequireDefault(_options);var _entry=require('./config/entry');var entry=_interopRequireWildcard(_entry);var _loader=require('./config/loader');var loaders=_interopRequireWildcard(_loader);var _uglify=require('./config/uglify');var _uglify2=_interopRequireDefault(_uglify);var _utils=require('./utils');function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}// 通用配置
var config={output:Object.assign(_options2.default.output,{filename:'[name].js'}),externals:_options2.default.externals,resolve:{alias:Object.assign(entry.configAlias,{'nodeModulesDir':_options2.default.nodeModulesDir}),extensions:['','.js','.jsx']},module:{noParse:[],loaders:[loaders.jsLoader('babelJs',[_options2.default.nodeModulesDir]),loaders.cssLoader(),loaders.lessLoader(),loaders.jsonLoader(),loaders.importsLoader(_options2.default.noParseDeps)]},plugins:[new _happypack2.default({id:'babelJs',threadPool:_happypack2.default.ThreadPool({size:6}),verbose:false,loaders:['babel-loader'],tempDir:_options2.default.happypackTempDir}),new _esExtractTextWebpackPlugin2.default('[name].css',{allChunks:true}),new _es3ifyWebpackPlugin2.default(),new _webpack2.default.ProvidePlugin(_options2.default.global),new _webpack2.default.optimize.AggressiveMergingPlugin(),new _webpack2.default.DefinePlugin({__DEBUG__:_options2.default.__DEBUG__,__DEV__:_options2.default.__DEV__}),new _optimizeModuleidAndChunkidPlugin2.default(),new _webpack2.default.optimize.OccurrenceOrderPlugin()]};_options2.default.noParseDeps.forEach(function(dep){var depPath=_path2.default.resolve(_options2.default.nodeModulesDir,dep);config.resolve.alias[dep.split(_path2.default.sep)[0].replace('.','-')]=depPath;config.module.noParse.push(depPath);});if(_options2.default.__DEV__){config.plugins.push(new _friendlyErrorsWebpackPlugin2.default());}if(_options2.default.__DEV__||_options2.default.__DEBUG__){config.devtool=_options2.default.__DEVTOOL__;}else{config.plugins.push(new _webpack2.default.optimize.UglifyJsPlugin(_uglify2.default));}var minChunks=function minChunks(module,count){// let pattern = new RegExp(options.regExp);
// return module.resource && !pattern.test(module.resource) && count >= options.minChunks;
return count>=_options2.default.minChunks;};// lib 配置
var libConfigs=[];if(_options2.default.isOpenLibModule){var libEntry=(0,_utils.filterObject)(entry.libEntry,'vendor');var vendorEntry=libEntry.filterObj;var newLibEntry=libEntry.newObj;var vendorConfig={};var newConfig={};var _module={loaders:[loaders.imageLoader('libs',_options2.default.imgName,_options2.default.imglimit),loaders.fontLoader('libs',_options2.default.fontName,_options2.default.fontlimit),loaders.mediaLoader('libs',_options2.default.mediaName)]};vendorConfig=(0,_webpackMerge2.default)(config,{name:'vendor',entry:vendorEntry,module:_module,plugins:[]});vendorConfig.externals={};if(_options2.default.__OPTIMIZE__){vendorConfig.plugins.push(new _webpackBundleAnalyzer.BundleAnalyzerPlugin({analyzerPort:3997}));};libConfigs.push(vendorConfig);newConfig=(0,_webpackMerge2.default)(config,{name:'libs',entry:newLibEntry,module:_module,plugins:[new _copyWebpackPlugin2.default(entry.onlyCopys)]});if(_options2.default.__OPTIMIZE__){newConfig.plugins.push(new _webpackBundleAnalyzer.BundleAnalyzerPlugin({analyzerPort:3998}));};libConfigs.push(newConfig);}// app 配置
var appConfig={};if(_options2.default.isOpenAppModule&&!(0,_utils.isEmptyObject)(entry.appEntry['app'])){appConfig=(0,_webpackMerge2.default)(config,{name:'app',entry:entry.appEntry['app'],module:{loaders:[loaders.imageLoader('app',_options2.default.imgName,_options2.default.imglimit),loaders.fontLoader('app',_options2.default.fontName,_options2.default.imglimit),loaders.mediaLoader('app',_options2.default.mediaName)]},plugins:[new _webpack2.default.optimize.CommonsChunkPlugin({name:'app',filename:'app/js/'+_options2.default.commonsChunkFileName+'.js',chunks:Object.keys(entry.appEntry['app']),minChunks:minChunks}),new _chunkManifestWebpackPlugin2.default({filename:'app/chunk-manifest.json',manifestVariable:"webpackManifest"})]});if(_options2.default.__OPTIMIZE__){appConfig.plugins.push(new _webpackBundleAnalyzer.BundleAnalyzerPlugin({analyzerPort:3999}));};if((0,_utils.fsExistsSync)(_options2.default.globalDir+'/app/'+_options2.default.copyName)){appConfig.plugins.push(new _copyWebpackPlugin2.default([{from:_options2.default.globalDir+'/app/'+_options2.default.copyName,to:'app/'+_options2.default.copyName,toType:'dir'}]));}}// plugin 配置
var pluginConfigs=[];if(_options2.default.isOpenPluginModule){var pluginEntryKeys=Object.keys(entry.pluginEntry);var index=0;pluginEntryKeys.forEach(function(key){var pluginConfig={};if((0,_utils.isEmptyObject)(entry.pluginEntry[key]))return;pluginConfig=(0,_webpackMerge2.default)(config,{name:''+key,entry:entry.pluginEntry[key],module:{loaders:[loaders.imageLoader(key,_options2.default.imgName,_options2.default.imglimit),loaders.fontLoader(key,_options2.default.fontName,_options2.default.fontlimit),loaders.mediaLoader(key,_options2.default.mediaName)]},plugins:[new _chunkManifestWebpackPlugin2.default({filename:key+'/chunk-manifest.json',manifestVariable:"webpackManifest"})]});if(_options2.default.__OPTIMIZE__){pluginConfig.plugins.push(new _webpackBundleAnalyzer.BundleAnalyzerPlugin({analyzerPort:'400'+index}));};if((0,_utils.fsExistsSync)(entry.pluginSrcEntry[key]+'/'+_options2.default.isNeedCommonChunk)){pluginConfig.plugins.push(new _webpack2.default.optimize.CommonsChunkPlugin({name:key,filename:key+'/js/'+_options2.default.commonsChunkFileName+'.js',chunks:Object.keys(entry.pluginEntry[key]),minChunks:minChunks}));}if((0,_utils.fsExistsSync)(entry.pluginSrcEntry[key]+'/'+_options2.default.copyName)){pluginConfig.plugins.push(new _copyWebpackPlugin2.default([{from:entry.pluginSrcEntry[key]+'/'+_options2.default.copyName,to:key+'/'+_options2.default.copyName,toType:'dir'}]));}pluginConfigs.push(pluginConfig);index++;});}// bundle 配置
var bundleConfigs=[];if(_options2.default.isOpenBundleModule){var bundleEntryKeys=Object.keys(entry.bundleEntry);var _index=0;bundleEntryKeys.forEach(function(key){var bundleConfig={};if((0,_utils.isEmptyObject)(entry.bundleEntry[key]))return;bundleConfig=(0,_webpackMerge2.default)(config,{name:''+key,entry:entry.bundleEntry[key],module:{loaders:[loaders.imageLoader(key,_options2.default.imgName,_options2.default.imglimit),loaders.fontLoader(key,_options2.default.fontName,_options2.default.fontlimit),loaders.mediaLoader(key,_options2.default.mediaName)]},plugins:[new _chunkManifestWebpackPlugin2.default({filename:key+'/chunk-manifest.json',manifestVariable:"webpackManifest"})]});if(_options2.default.__OPTIMIZE__){bundleConfig.plugins.push(new _webpackBundleAnalyzer.BundleAnalyzerPlugin({analyzerPort:'410'+_index}));};if((0,_utils.fsExistsSync)(entry.bundleSrcEntry[key]+'/'+_options2.default.isNeedCommonChunk)){bundleConfig.plugins.push(new _webpack2.default.optimize.CommonsChunkPlugin({name:key,filename:key+'/js/'+_options2.default.commonsChunkFileName+'.js',chunks:Object.keys(entry.bundleEntry[key]),minChunks:minChunks}));}if((0,_utils.fsExistsSync)(entry.bundleSrcEntry[key]+'/'+_options2.default.copyName)){bundleConfig.plugins.push(new _copyWebpackPlugin2.default([{from:entry.bundleSrcEntry[key]+'/'+_options2.default.copyName,to:key+'/'+_options2.default.copyName,toType:'dir'}]));}bundleConfigs.push(bundleConfig);_index++;});}// theme 配置
var themeConfigs=[];if(_options2.default.isOpenThemeModule){var themeEntryKeys=Object.keys(entry.themeEntry);themeEntryKeys.forEach(function(key){var themeConfig={};if((0,_utils.isEmptyObject)(entry.themeEntry[key]))return;themeConfig=(0,_webpackMerge2.default)(config,{name:''+key,entry:entry.themeEntry[key],module:{loaders:[loaders.imageLoader(key,_options2.default.imgName,_options2.default.imglimit),loaders.fontLoader(key,_options2.default.fontName,_options2.default.fontlimit),loaders.mediaLoader(key,_options2.default.mediaName)]},plugins:[new _chunkManifestWebpackPlugin2.default({filename:key+'/chunk-manifest.json',manifestVariable:"webpackManifest"})]});if((0,_utils.fsExistsSync)(entry.themeSrcEntry[key]+'/'+_options2.default.copyName)){themeConfig.plugins.push(new _copyWebpackPlugin2.default([{from:entry.themeSrcEntry[key]+'/'+_options2.default.copyName,to:key+'/'+_options2.default.copyName,toType:'dir'}]));}themeConfigs.push(themeConfig);});}// 总配置
var configs=[];[libConfigs,appConfig,pluginConfigs,bundleConfigs,themeConfigs].forEach(function(item){if(item.constructor===Object&&!(0,_utils.isEmptyObject)(item)){configs.push(item);}else if(item.constructor===Array&&item.length){configs=configs.concat(item);}});exports.default=configs;